<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <style media="screen">
    div#mp3_player{ width:500px; height:60px; background:#000; padding:5px; margin:50px; }
    div#mp3_player > div > audio{  width:500px; background:#000; float:left;  }
    div#mp3_player > canvas{ width:1500px; height:300px; background:#002D3C; float:left; }
    </style>
    <script type="text/javascript">
      //Création des variables que l'analyseur va utiliser.
      var canvas, ctx, source, context, analyser, fbc_array, bars, bar_x, bar_width, bar_height;
      //Initialisation du lecteur mp3 après que la page ait chargé tous ses éléments dans la page.
      window.addEventListener("load", initMp3Player, false);
      // frameLooper() animates any style of graphics you wish to the audio frequency
      // Looping at the default frame rate that the browser provides(approx. 60 FPS)
      function frameLooper(){
      	window.requestAnimationFrame(frameLooper);
        // analyser.frequencyBinCount = 1024
      	fbc_array = new Uint8Array(analyser.frequencyBinCount);//Renvoie un tableau de 1024 binaires.
        // console.log("fbc_array: " + fbc_array);
      	analyser.getByteFrequencyData(fbc_array);
      	ctx.clearRect(0, 0, canvas.width, canvas.height); //Efface le canvas
      	ctx.fillStyle = '#CCFF00'; // Couleur des barres
      	bars = 500;
        pos_bar_x = 0;

      	for (var i = 200; i < bars; i++) {
      		bar_x = pos_bar_x; //bar_x correspond à la position de la barre sur l'axe des x du canvas.
          pos_bar_x++;
      		bar_width = 1; //bar_width correspond à la largeur de la barre.
      		bar_height = -(fbc_array[i] / 2);//fbc_array[i] renvoie une valeur de 0 à 255
      		//  fillRect(position x, position y, largeur, hauteur)
      		ctx.fillRect(bar_x, canvas.height, bar_width, bar_height);
      	}
      }
      function initMp3Player(){
      	var audio = document.getElementById('audio_box');//Le lecteur qui contient le son
      	context = new AudioContext(); //Instance de l'objet AudioContext
      	analyser = context.createAnalyser(); //Méthode de l'AnalyserNode
      	canvas = document.getElementById('analyser');
      	ctx = canvas.getContext('2d');
      	source = context.createMediaElementSource(audio);// Re-route audio playback into the processing graph of the AudioContext
      	source.connect(analyser);//Connexion du son à l'analyser (context.createAnalyser)
      	analyser.connect(context.destination);
      	frameLooper();
      }
    </script>
  </head>
  <body>
    <div id="mp3_player">
      <audio id="audio_box" src="Wa-Do-Dem.mp3" controls></audio>
      <canvas id="analyser"></canvas>
    </div>
  </body>
</html>
